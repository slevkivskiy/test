name: Deploy to AWS

on:
  push:
    branches:
      - main  # –°–ø—Ä–∞—Ü—å–æ–≤—É—î, –∫–æ–ª–∏ —Ç–∏ –ø—É—à–∏—à –≤ main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          # 1. –ó–∞—Ö–æ–¥–∏–º–æ –≤ –ø–∞–ø–∫—É
          cd test
          
          # 2. –°—Ç—è–≥—É—î–º–æ –∫–æ–¥
          git pull origin main
          
          # 3. üî• –ú–ê–ì–Ü–Ø: –°—Ç–≤–æ—Ä—é—î–º–æ .env —Ñ–∞–π–ª –ø—Ä—è–º–æ —Ç—É—Ç!
          # –ú–∏ –±–µ—Ä–µ–º–æ —Å–µ–∫—Ä–µ—Ç–∏ –∑ GitHub —ñ –∫–ª–∞–¥–µ–º–æ —ó—Ö —É —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
          
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
          echo "ADMIN_ID=${{ secrets.ADMIN_ID }}" >> .env
          echo "WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_KEY }}" >> .env
          
          # 4. –ü–µ—Ä–µ–∑–±–∏—Ä–∞—î–º–æ –∑ "—Å–∏–ª–æ–≤–∏–º" –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
          # --force-recreate –∑–º—É—à—É—î Docker –ø–æ–±–∞—á–∏—Ç–∏ –Ω–æ–≤–∏–π .env
          docker compose up -d --build --force-recreate
